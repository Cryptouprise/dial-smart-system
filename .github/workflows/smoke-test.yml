name: Smoke Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
        continue-on-error: true
      
      - name: Check TypeScript types
        run: npx tsc --noEmit
        continue-on-error: true

  integration-test:
    name: Integration Test (Optional)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Only run if secrets are available (not required for PR from forks)
    if: ${{ vars.ENABLE_INTEGRATION_TESTS == 'true' && secrets.SUPABASE_URL != '' }}
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run credentials check test
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          TEST_TO_NUMBER: ${{ secrets.TEST_TO_NUMBER }}
          TEST_FROM_NUMBER: ${{ secrets.TEST_FROM_NUMBER }}
        run: |
          echo "Testing credentials check endpoint..."
          node scripts/integration/test-outbound-call.js || true
        continue-on-error: true
      
      - name: Summary
        run: |
          echo "Integration tests completed. Check logs above for results."
          echo "Note: Integration tests are optional and may fail if credentials are not configured."

  build:
    name: Build Application
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
        env:
          # Provide dummy values for build-time env vars if needed
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'https://example.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'dummy-key-for-build' }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [lint, build]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Build: ${{ needs.build.result }}"
          
          if [[ "${{ needs.lint.result }}" == "failure" ]] || [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "❌ Some required jobs failed"
            exit 1
          else
            echo "✅ All required jobs passed"
          fi
